
# 特定设备自动化配置网卡
CURRENT_UUID=$(cat /sys/class/dmi/id/product_uuid 2>/dev/null | tr 'A-Z' 'a-z')

if [ "$CURRENT_UUID" = "87e9f45c-ff46-4fa2-bb22-80a5b22fc7dc" ]; then
	uci -q batch <<-EOF
		# 配置 br-lan 网口
		del network.@device[0].ports
		add_list network.@device[0].ports='eth0'
		add_list network.@device[0].ports='eth1'
		# 配置 wan 网口
		set network.wan.device='eth2'
	EOF
fi


# 删除 WAN6 接口
uci -q batch <<-EOF
	del network.wan6
	commit network
EOF


# 防火墙调整
uci -q batch <<-EOF
	del firewall.@zone[0].network
	add_list firewall.@zone[0].network='lan'
	del firewall.@zone[1].network
	add_list firewall.@zone[1].network='wan'

	del firewall.@defaults[0].syn_flood
	del firewall.@defaults[0].fullcone6
	set firewall.@defaults[0].synflood_protect='1'

	# x86 仅支持软件流量卸载
	set firewall.@defaults[0].flow_offloading='1'
	del firewall.@defaults[0].flow_offloading_hw

	commit firewall
EOF


# DHCP 配置调整
uci -q batch <<-EOF
	# 禁用 IPv6 DHCP
	del dhcp.lan.ra
	del dhcp.lan.ra_slaac
	del dhcp.lan.max_preferred_lifetime
	del dhcp.lan.max_valid_lifetime
	del dhcp.lan.dhcpv6

	# 强制 DHCP
	set dhcp.lan.force='1'

	# DNS 配置调整
	del dhcp.@dnsmasq[0].nonwildcard
	del dhcp.@dnsmasq[0].rebind_localhost
	del dhcp.@dnsmasq[0].boguspriv
	del dhcp.@dnsmasq[0].filterwin2k
	del dhcp.@dnsmasq[0].filter_a
	set dhcp.@dnsmasq[0].rebind_protection='0'
	set dhcp.@dnsmasq[0].filter_aaaa='1'

	commit dhcp
EOF


# UPnP 配置调整
uci -q batch <<-EOF
	del upnpd.config.enable_upnp
	del upnpd.config.enable_natpmp
	del upnpd.config.use_stun
	del upnpd.config.stun_host
	del upnpd.config.stun_port
	del upnpd.config.secure_mode
	del upnpd.config.log_output
	set upnpd.config.enabled='0'
	set upnpd.config.download='102400'
	set upnpd.config.upload='5120'

	commit upnpd
EOF


# 网络诊断
if [ "$(uci -q get luci.diag.ping)" = "openwrt.org" ] || [ "$(uci -q get luci.diag.ping)" = "immortalwrt.org" ]; then
	uci -q batch <<-EOF
		set luci.diag.dns='www.qq.com'
		set luci.diag.ping='www.qq.com'
		set luci.diag.route='www.qq.com'
		commit luci
	EOF
fi


#/etc/init.d/network restart
#/etc/init.d/firewall restart
#/etc/init.d/dnsmasq restart
#/etc/init.d/odhcpd restart
#/etc/init.d/miniupnpd restart


exit 0
